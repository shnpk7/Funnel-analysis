-- *************
-- DATA CLEANING
-- *************

-- 1. Create events_cleaned with Parsed Columns
CREATE TABLE events_cleaned AS
SELECT 
  *,  -- include all original columns
  (REPLACE(value, '''', '"')::json->>'amount')::double precision AS amount,
  REPLACE(value, '''', '"')::json->>'offer id' AS offer_id,
  (REPLACE(value, '''', '"')::json->>'reward')::double precision AS reward
FROM events

-- 2. Identify events for funnel analysis
SELECT 
	DISTINCT(event)
FROM events_cleaned

/* Identified that I can use EVENT column for funnel analysis, using dimensions including reward amount, reward type, transaction amount.
FROM the offers table, can use duration, reward amount and channels for dimensions. */


-- *************************
-- EXPLORATORY DATA ANALYSIS
-- *************************

-- 1. Basic funnel count
SELECT event, COUNT(DISTINCT customer_id) AS event_count
FROM events_cleaned
WHERE event IN ('offer received', 'offer viewed', 'offer completed')
GROUP BY event

UNION ALL

SELECT 'signup' AS event, 17000 AS event_count

ORDER BY 2 DESC

-- 2: 
